pipeline:
  push_to_github:
    image: nixpkgs/nix-flakes:latest
    pull: true
    commands:
      - mkdir -p ~/.config/nix
      - echo "substituters = s3://nix-store?endpoint=objects.cyplo.dev&scheme=https&region=cyplodev https://cache.nixos.org/" >> ~/.config/nix/nix.conf 
      - export AWS_ACCESS_KEY_ID="nix-builder"
      - export AWS_SECRET_ACCESS_KEY="$MINIO_NIX_BUILDER_KEY"
      - nix develop --no-sandbox -c git fetch --unshallow origin
      - nix develop --no-sandbox -c git remote add github https://cyplo:$GITHUB_TOKEN@github.com/cyplo/genpass.git
      - nix develop --no-sandbox -c git push github --all --force
    secrets: [ github_token ]
